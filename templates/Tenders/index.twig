{% extends 'backend_layout.twig' %}

{%
    set CRUDRoutes = {
        'create'   : currentRoute ~ '_create',
        'get'      : currentRoute ~ '_get',
        'delete'   : currentRoute ~ '_delete',
        'newChild' : currentRoute ~ '_newChild',
        'move'     : currentRoute ~ '_move',
    }
%}

{% block content %}
    <!-- Content Header (Page header) -->
    <section class="content-header">
        <h1>{{ pageTitle }}</h1>
    </section>

    <!-- Main content -->
    <section class="content">
        {% if myTenders is defined %}
            <div class="box box-primary">
                <div class="box-header with-border">
                    <h3 class="box-title">{{ 'My tenders'|trans }}</h3>
                    <div class="box-tools pull-right">
                        <a class="btn btn-success btn-sm" href="{{ path_for(CRUDRoutes.create, {'lang': lang}) }}" data-toggle="tooltip" title="" data-html="true" data-original-title="{{ 'Add new tender'|trans }}<br>{{ 'Cost of new tender: %money% AZN'|trans({'%money%': 0})}}{{ 'promo action'|trans }}" ><i class="fa fa-plus fa-lg"></i></a>
                    </div>
                </div>
                <div class="box-body">
                    {% if myTenders.data|length > 0 %}
                        <table id="myTenders" class="table table-striped table-bordered table-hover"></table>
                    {% else %}
                        {{ 'You do not have tenders'|trans }}
                    {% endif %}
                </div>
            </div>
        {% endif %}

        {% if activeTenders is defined %}
            <div class="box box-primary">
                <div class="box-header with-border">
                    <h3 class="box-title">{{ 'Active tenders'|trans }}</h3>
                </div>
                <div class="box-body">
                    {% if activeTenders.data|length > 0 %}
                        <table id="activeTenders" class="table table-striped table-bordered table-hover"></table>
                    {% else %}
                        {{ 'There are no tenders at the moment.'|trans }}
                    {% endif %}
                </div>
            </div>
        {% endif %}
    </section>
    <!-- /.content -->
{% endblock %}

{% block head %}
    {{ parent() }}

    <link type="text/css" rel="stylesheet" href="{{ base_url() }}/assets/magnific-popup/dist/magnific-popup.css?ver={{ version }}">

    <link type="text/css" rel="stylesheet" href="{{ base_url() }}/libs/DataTables/dataTables.min.css">
    <link type="text/css" rel="stylesheet" href="{{ base_url() }}/libs/dataTableExportCollection/dataTableExportCollection.css">

    <style>
        .tooltip-inner{
            text-align: left;
         //   position: fixed;
        }
    </style>
{% endblock %}

{% block scripts %}
    {{ parent() }}

    <script type="text/javascript" src="{{ base_url() }}/assets/magnific-popup/dist/jquery.magnific-popup.min.js?ver={{ version }}"></script>

    <script type="text/javascript" src="{{ base_url() }}/libs/DataTables/datatables.min.js"></script>
    <script type="text/javascript" src="{{ base_url() }}/assets/dataTableSelectAllBtn/dataTableSelectAllBtn.js"></script>
    <script type="text/javascript" src="{{ base_url() }}/libs/dataTableExportCollection/dataTableExportCollection.js"></script>

    <script type="text/javascript">
        $(document).ready(function(){
            $.extend( true, $.fn.dataTable.defaults, {
                dom: "<'row'<'col-sm-6'l><'col-sm-6'fr>>" +
                     "<'row'<'col-sm-12't>>" +
                     "<'row'<'col-sm-5'i><'col-sm-7'p>>",

                iDisplayLength: 15,
                aLengthMenu: [ [15, 50, -1], [15, 50, "All"] ],
                language: {
                    url: "{{ base_url() }}/libs/DataTables/Plugins-1.10.16/i18n/{{ lang }}.json",
                },
                "columnDefs": [{
                    "targets": 'no-sort',
                    "orderable": false,
                }],

                "ordering": false,
                "aaSorting": [],   /* Disable initial sort */
                //"aaSorting": [[ 0, 'asc' ]],

                "autoWidth": false,

                "scrollX": true,
            } );
        });
    </script>

    <script type="text/javascript">
        $(document).ready(function(){
            {% if (myTenders is defined) and (myTenders.data|length > 0) %}
                var activeTenders = $("#myTenders").DataTable({
                    dom: "<'row'<'col-sm-6'l><'col-sm-6'fr>>" +
                    "<'row'<'col-sm-12't>>" +
                    "<'row'<'col-sm-5'i><'col-sm-7'p>>",

                    data    : {{ myTenders.data|raw }},
                    columns : {{ myTenders.columns|raw }},
                    rowId   : 0,

                    "columnDefs": [
                        { "width": "100px", "targets": [-1, -2] },
                        { "width": "70px", "targets": [-3] },
                        { "width": "120px", "targets": [-4] },
                    ],

                    "initComplete": function (settings, json) {
                        var api = this.api();

                        // Add add
                        new $.fn.dataTable.Buttons( api, {
                            name: 'main',
                            buttons: [
                                {
                                    text: '<i class="fa fa-plus fa-lg"></i>',
                                    titleAttr: '{{ 'Add new item'|trans }}',
                                    className: 'text-green',
                                    action: function ( e, dt, node, conf ) {
                                        window.location = "{{ path_for(CRUDRoutes.create, {'lang': lang}) }}";
                                    }
                                }
                            ]
                        }).container().appendTo(
                            $('.dataTableExtraBtns', api.table().container() )
                        );

                        api.columns(0).every( function () {
                            var column = this;
                            var select = $('<select class="form-control " style="width: 100%; padding: 0 10px; height: 20px;"><option value=""></option></select>')
                                    .appendTo( $(column.header()).empty() )
                                    .on( 'change', function () {
                                        var val = $.fn.dataTable.util.escapeRegex($(this).val());
                                        column.search( val ? '^'+val+'$' : '', true, false ).draw();
                                    });

                            column.data().unique().sort().each( function ( d, j ) {
                                select.append( '<option value="'+d+'">'+d+'</option>' )
                            });
                        });

                        $('.magnificPopup').magnificPopup({
                            type: 'ajax',
                            ajax: {
                                settings: null, // Ajax settings object that will extend default one - http://api.jquery.com/jQuery.ajax/#jQuery-ajax-settings
                                cursor: 'mfp-ajax-cur', // CSS class that will be added to body during the loading (adds "progress" cursor)
                                tError: '<a href="%url%">The content could not be loaded.</a>' //  Error message, can contain %curr% and %total% tags if gallery is enabled
                            },
                            callbacks: {
                                ajaxContentAdded: function() {
                                    // Ajax content is loaded and appended to DOM
                                    //initializeSelect2();
                                }
                            }
                        });
                    },
                });

            {% endif %}

            {% if (activeTenders is defined) and (activeTenders.data|length > 0) %}
                var activeTenders = $("#activeTenders").DataTable({
                    data    : {{ activeTenders.data|raw }},
                    columns : {{ activeTenders.columns|raw }},
                    rowId   : 0,

                    "columnDefs": [
                        { "width": "100px", "targets": [-1] },
                        { "width": "120px", "targets": [-2] },
                    ],

                    "initComplete": function (settings, json) {

                        this.api().columns(0).every( function () {
                            var column = this;
                            var select = $('<select class="form-control " style="width: 100%; padding: 0 10px; height: 20px;"><option value=""></option></select>')
                                .appendTo( $(column.header()).empty() )
                                .on( 'change', function () {
                                    var val = $.fn.dataTable.util.escapeRegex($(this).val());
                                    column.search( val ? '^'+val+'$' : '', true, false ).draw();
                                });

                            column.data().unique().sort().each( function ( d, j ) {
                                select.append( '<option value="'+d+'">'+d+'</option>' )
                            });
                        });

	                    $('.magnificPopup').magnificPopup({
		                    type: 'ajax',
		                    ajax: {
			                    settings: null, // Ajax settings object that will extend default one - http://api.jquery.com/jQuery.ajax/#jQuery-ajax-settings
			                    cursor: 'mfp-ajax-cur', // CSS class that will be added to body during the loading (adds "progress" cursor)
			                    tError: '<a href="%url%">The content could not be loaded.</a>' //  Error message, can contain %curr% and %total% tags if gallery is enabled
		                    },
		                    callbacks: {
			                    ajaxContentAdded: function() {
				                    // Ajax content is loaded and appended to DOM
				                    //initializeSelect2();
			                    }
		                    }
	                    });
                        $("[data-toggle='tooltip']").tooltip({placement: 'left'});
                    },
                });
            {% endif %}
        });
    </script>
{% endblock %}